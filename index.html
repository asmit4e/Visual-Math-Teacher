<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Visual Math Teacher â€“ AI Powered Solver</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Lora:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    h1, h2, h3 { font-family: 'Lora', serif; }
    .dropzone { border: 2px dashed #d1d5db; transition: background-color 0.2s ease; }
    .dropzone.dragover { background-color: #e5e7eb; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .solution-step {
        border-left: 3px solid #3b82f6; /* blue-500 */
        padding-left: 1rem;
        margin-top: 0.75rem;
    }
    .solution-step:last-child {
        border-left-color: #16a34a; /* green-600 */
        font-weight: 600;
    }
    /* Loading Spinner */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
  <!-- math.js (for final evaluation) -->
  <script src="https://cdn.jsdelivr.net/npm/mathjs@14/lib/browser/math.js"></script>
</head>
<body class="text-gray-800">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold">ðŸ§  AI Visual Math Teacher</h1>
      <p class="text-gray-600 mt-2">Get AI-powered, step-by-step explanations for handwritten and printed math problems.</p>
    </header>

    <main class="grid md:grid-cols-2 gap-8">
      <!-- Left Panel: Input & Controls -->
      <div class="space-y-6">
        <div class="bg-white rounded-2xl shadow-lg p-6 dropzone" id="dropzone">
          <div class="flex flex-col items-center text-center gap-3 py-8">
            <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            <div class="text-lg font-semibold">Drop an image here</div>
            <div class="text-gray-500 text-sm">or</div>
            <div class="flex flex-col sm:flex-row gap-3">
                <label class="inline-flex items-center gap-2 px-5 py-2.5 rounded-full bg-blue-600 text-white cursor-pointer hover:bg-blue-700 transition">
                  <input type="file" id="fileInput" accept="image/*" class="hidden" />
                  <span>Upload Image</span>
                </label>
                <button id="cameraBtn" class="px-5 py-2.5 rounded-full border bg-white hover:bg-gray-100 transition">Use Camera</button>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg overflow-hidden hidden" id="cameraCard">
          <div class="p-4 flex items-center justify-between border-b">
            <h2 class="text-xl font-semibold">Camera</h2>
            <button id="closeCam" class="text-sm text-gray-500 hover:text-gray-800">&times; Close</button>
          </div>
          <div class="p-4">
            <video id="video" autoplay playsinline class="w-full rounded-xl bg-black"></video>
            <div class="flex gap-3 mt-3">
              <button id="snap" class="flex-grow px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700 transition">Capture</button>
              <button id="switchCam" class="px-4 py-2 rounded-xl border hover:bg-gray-100 transition">Switch Camera</button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
          </div>
        </div>

        <div class="bg-white rounded-2xl shadow-lg p-6">
          <div class="flex items-center justify-between mb-2">
            <h2 class="text-xl font-semibold">AI Recognized Problem</h2>
            <div id="ocrStatus" class="text-sm text-gray-500"></div>
          </div>
          <textarea id="ocrText" class="w-full mt-2 p-3 border rounded-xl mono min-h-[100px] bg-gray-50 focus:ring-2 focus:ring-blue-500" placeholder="AI output will appear here..."></textarea>
          <div class="flex gap-3 mt-4">
            <button id="runSolve" class="px-5 py-2.5 rounded-full bg-blue-600 text-white hover:bg-blue-700 transition">Get AI Solution</button>
            <button id="clearAll" class="px-5 py-2.5 rounded-full border bg-white hover:bg-gray-100 transition">Clear</button>
          </div>
        </div>
      </div>

      <!-- Right Panel: Output & Solutions -->
      <div class="bg-white rounded-2xl shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-2">AI Teacher's Explanation</h2>
        <div id="solutions" class="mt-4 space-y-4">
          <div class="text-center text-gray-400 py-4">Solutions will appear here.</div>
        </div>
      </div>
    </main>

    <footer class="text-center text-sm text-gray-500 mt-12 pb-6">
      Â© 2025 Visual Math Teacher â€“ AI Powered Demo
    </footer>
  </div>

  <script>
    // --- DOM Element References ---
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const ocrText = document.getElementById('ocrText');
    const ocrStatus = document.getElementById('ocrStatus');
    const solutions = document.getElementById('solutions');
    const cameraBtn = document.getElementById('cameraBtn');
    const cameraCard = document.getElementById('cameraCard');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snap = document.getElementById('snap');
    const closeCam = document.getElementById('closeCam');
    const switchCam = document.getElementById('switchCam');

    let currentStream = null;
    let useRear = true;

    // --- Core Functions ---
    function stopStream() {
      if (currentStream) {
        currentStream.getTracks().forEach(t => t.stop());
        currentStream = null;
      }
    }

    async function startCamera() {
      try {
        stopStream();
        const constraints = { video: { facingMode: useRear ? { ideal: 'environment' } : 'user' }, audio: false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        currentStream = stream;
        video.srcObject = stream;
        cameraCard.classList.remove('hidden');
      } catch (err) {
        alert('Camera error: ' + err.message);
      }
    }

    async function handleImageFile(file) {
      clearAll();
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64Data = reader.result.split(',')[1];
        runAdvancedOCR(base64Data);
      };
      reader.readAsDataURL(file);
    }

    async function runAdvancedOCR(base64ImageData) {
        ocrStatus.textContent = 'AI is analyzing...';
        ocrText.value = '';

        const prompt = "Transcribe the mathematical expression(s) in this image. Only return the raw text of the expressions, each on a new line. Do not solve them.";
        
        try {
            const result = await callGeminiAPI(prompt, base64ImageData);
            ocrText.value = result.trim();
            ocrStatus.textContent = 'Ready to solve!';
        } catch (error) {
            console.error("Gemini OCR Error:", error);
            ocrStatus.textContent = 'AI analysis failed.';
            alert("Sorry, the AI could not read the image. Please try a clearer picture.");
        }
    }

    async function getAISolution() {
        const problem = ocrText.value.trim();
        if (!problem) {
            alert("Please provide a math problem first.");
            return;
        }

        solutions.innerHTML = '<div class="flex flex-col items-center gap-3 py-4"><div class="loader"></div><div class="text-gray-500">AI Teacher is thinking...</div></div>';

        const prompt = `Act as a friendly math teacher. A student has provided the following problem: "${problem}". 
        First, provide a final, bolded answer. 
        Then, in a section titled "Step-by-Step Explanation", explain how to solve it in a clear, step-by-step manner. Use simple language.`;

        try {
            const result = await callGeminiAPI(prompt);
            // Format the result nicely
            let formattedResult = result
                .replace(/Step-by-Step Explanation/g, '<h3 class="text-lg font-semibold mt-4">Step-by-Step Explanation</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold text
                .replace(/\n/g, '<br>'); // New lines
            
            solutions.innerHTML = `<div class="prose">${formattedResult}</div>`;
        } catch (error) {
            console.error("Gemini Solution Error:", error);
            solutions.innerHTML = '<div class="text-center text-red-500 py-4">Sorry, the AI teacher had trouble solving this problem. Please try again.</div>';
        }
    }

    async function callGeminiAPI(prompt, base64ImageData = null) {
        let chatHistory = [];
        const parts = [{ text: prompt }];
        if (base64ImageData) {
            parts.push({ inlineData: { mimeType: "image/jpeg", data: base64ImageData } });
        }
        chatHistory.push({ role: "user", parts: parts });

        const payload = { contents: chatHistory };
        const apiKey = ""; // API key will be handled by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
        }

        const result = await response.json();
        if (result.candidates && result.candidates[0]?.content?.parts[0]?.text) {
            return result.candidates[0].content.parts[0].text;
        } else {
            throw new Error("Invalid response structure from API.");
        }
    }
    
    function clearAll() {
        ocrText.value = '';
        solutions.innerHTML = '<div class="text-center text-gray-400 py-4">Solutions will appear here.</div>';
        ocrStatus.textContent = '';
        fileInput.value = ''; // Reset file input
    }

    // --- Event Listeners ---
    cameraBtn.addEventListener('click', startCamera);
    switchCam.addEventListener('click', () => { useRear = !useRear; startCamera(); });
    closeCam.addEventListener('click', () => { stopStream(); cameraCard.classList.add('hidden'); });
    snap.addEventListener('click', () => {
      if (!video.videoWidth) return;
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/jpeg');
      const base64Data = dataUrl.split(',')[1];
      runAdvancedOCR(base64Data);
      stopStream();
      cameraCard.classList.add('hidden');
    });

    ;['dragenter','dragover'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.add('dragover'); }));
    ;['dragleave','drop'].forEach(evt => dropzone.addEventListener(evt, e => { e.preventDefault(); dropzone.classList.remove('dragover'); }));
    dropzone.addEventListener('drop', e => { const f = e.dataTransfer.files?.[0]; if (f) handleImageFile(f); });
    fileInput.addEventListener('change', e => { const f = e.target.files?.[0]; if (f) handleImageFile(f); });
    
    document.getElementById('runSolve').addEventListener('click', getAISolution);
    document.getElementById('clearAll').addEventListener('click', clearAll);
  </script>
</body>
</html>
